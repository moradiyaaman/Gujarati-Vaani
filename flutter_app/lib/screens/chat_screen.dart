import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';
import 'dart:async';
import 'package:audioplayers/audioplayers.dart';
import '../services/tts_service.dart';

class ChatMessage {
  final String text;
  final bool isUser;
  final DateTime timestamp;
  String? audioPath;
  bool isGeneratingAudio;

  ChatMessage({
    required this.text,
    required this.isUser,
    DateTime? timestamp,
    this.audioPath,
    this.isGeneratingAudio = false,
  }) : timestamp = timestamp ?? DateTime.now();
}

class ChatScreen extends StatefulWidget {
  const ChatScreen({super.key});

  @override
  State<ChatScreen> createState() => _ChatScreenState();
}

class _ChatScreenState extends State<ChatScreen> {
  final TextEditingController _messageController = TextEditingController();
  final ScrollController _scrollController = ScrollController();
  final AudioPlayer _audioPlayer = AudioPlayer();
  final List<ChatMessage> _messages = [];
  bool _isTyping = false;
  int? _playingIndex;

  // Free AI APIs to try
  static const String _hfApiUrl =
      'https://api-inference.huggingface.co/models/google/gemma-2-2b-it';

  // Alternative: Google Gemini free API (no key needed for low volume)
  static const String _hfApiUrl2 =
      'https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.3';

  @override
  void initState() {
    super.initState();
    _setupAudioPlayer();
    // Welcome message
    _messages.add(ChatMessage(
      text:
          'ркиркорк╕рлНркдрлЗ! рк╣рлБркВ ркЧрлБркЬрк░рк╛ркдрлА AI рк╕рк╣рк╛ркпркХ ркЫрлБркВред ркдркорлЗ ркоркирлЗ ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ ркХркВркИрккркг рккрлВркЫрлА рк╢ркХрлЛ ркЫрлЛред ркорк╛рк░рк╛ ркЬрк╡рк╛ркмрлЛ рк╕рк╛ркВркнрк│рк╡рк╛ ркорк╛ркЯрлЗ ЁЯФК ркмркЯрки ркжркмрк╛рк╡рлЛред\n\n(Hello! I am a Gujarati AI assistant. You can ask me anything in Gujarati. Press the ЁЯФК button to listen to my responses.)',
      isUser: false,
    ));
  }

  void _setupAudioPlayer() {
    _audioPlayer.onPlayerComplete.listen((_) {
      if (mounted) setState(() => _playingIndex = null);
    });
  }

  @override
  void dispose() {
    _messageController.dispose();
    _scrollController.dispose();
    _audioPlayer.dispose();
    super.dispose();
  }

  void _scrollToBottom() {
    Future.delayed(const Duration(milliseconds: 100), () {
      if (_scrollController.hasClients) {
        _scrollController.animateTo(
          _scrollController.position.maxScrollExtent,
          duration: const Duration(milliseconds: 300),
          curve: Curves.easeOut,
        );
      }
    });
  }

  Future<void> _sendMessage() async {
    final text = _messageController.text.trim();
    if (text.isEmpty) return;

    _messageController.clear();

    setState(() {
      _messages.add(ChatMessage(text: text, isUser: true));
      _isTyping = true;
    });
    _scrollToBottom();

    try {
      final response = await _getAIResponse(text);
      setState(() {
        _messages.add(ChatMessage(text: response, isUser: false));
        _isTyping = false;
      });
      _scrollToBottom();
    } catch (e) {
      setState(() {
        _messages.add(ChatMessage(
          text:
              'ркорк╛ркл ркХрк░рк╢рлЛ, ркЬрк╡рк╛ркм ркорлЗрк│рк╡рк╡рк╛ркорк╛ркВ ркдрлНрк░рлБркЯрк┐ ркеркИред рклрк░рлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛред\n(Sorry, error getting response. Please try again.)',
          isUser: false,
        ));
        _isTyping = false;
      });
      _scrollToBottom();
    }
  }

  Future<String> _getAIResponse(String userMessage) async {
    // Try HuggingFace Gemma first
    try {
      final response = await _tryHuggingFaceAPI(_hfApiUrl, userMessage);
      if (response != null && response.isNotEmpty) return response;
    } catch (_) {}

    // Try Mistral as fallback
    try {
      final response = await _tryHuggingFaceAPI(_hfApiUrl2, userMessage);
      if (response != null && response.isNotEmpty) return response;
    } catch (_) {}

    // Use smart fallback - always gives a good Gujarati response
    return _getSmartResponse(userMessage);
  }

  Future<String?> _tryHuggingFaceAPI(String apiUrl, String userMessage) async {
    final prompt = apiUrl.contains('gemma')
        ? '''<start_of_turn>user
You are a helpful AI assistant. Always respond ONLY in Gujarati language using Gujarati script (ркЧрлБркЬрк░рк╛ркдрлА). Give helpful, accurate responses in 2-4 sentences.

Question: $userMessage<end_of_turn>
<start_of_turn>model
'''
        : '''<s>[INST] You are a helpful AI assistant. Always respond ONLY in Gujarati language using Gujarati script (ркЧрлБркЬрк░рк╛ркдрлА). Give helpful, accurate, informative responses in 2-4 sentences.

Question: $userMessage [/INST]''';

    final response = await http
        .post(
          Uri.parse(apiUrl),
          headers: {'Content-Type': 'application/json'},
          body: json.encode({
            'inputs': prompt,
            'parameters': {
              'max_new_tokens': 300,
              'temperature': 0.7,
              'top_p': 0.9,
              'do_sample': true,
              'return_full_text': false,
            },
          }),
        )
        .timeout(const Duration(seconds: 20));

    if (response.statusCode == 200) {
      final data = json.decode(response.body);
      if (data is List && data.isNotEmpty) {
        String text = data[0]['generated_text'] ?? '';
        text = text
            .replaceAll('<end_of_turn>', '')
            .replaceAll('<start_of_turn>', '')
            .replaceAll('[/INST]', '')
            .replaceAll('</s>', '')
            .trim();

        // Verify the response actually contains Gujarati text
        final gujaratiChars =
            RegExp(r'[\u0A80-\u0AFF]').allMatches(text).length;
        if (gujaratiChars >= 5 && text.length >= 20) {
          return text;
        }
      }
    }
    return null;
  }

  /// Smart response system with comprehensive Gujarati knowledge base
  String _getSmartResponse(String userMessage) {
    final lower = userMessage.toLowerCase();
    final msg = userMessage;

    // --- Greetings ---
    if (_matchesAny(lower, ['ркиркорк╕рлНркдрлЗ', 'рк╣рлЗрк▓рлЛ', 'hello', 'hi', 'ркЬркп рк╢рлНрк░рлА', 'рк░рк╛рко рк░рк╛рко', 'рк╕ркд рк╢рлНрк░рлА'])) {
      return 'ркиркорк╕рлНркдрлЗ! рк╣рлБркВ ркЧрлБркЬрк░рк╛ркдрлА рк╡рк╛ркгрлА AI рк╕рк╣рк╛ркпркХ ркЫрлБркВред рк╣рлБркВ ркдркоркирлЗ ркЧрлБркЬрк░рк╛ркдрлА ркнрк╛рк╖рк╛, рк╕ркВрк╕рлНркХрлГркдрк┐, ркИркдрк┐рк╣рк╛рк╕, ркЦрк╛ркгрлАрккрлАркгрлА, рк╕рк╛рк╣рк┐ркдрлНркп ркЕркирлЗ ркмрлАркЬрк╛ ркШркгрк╛ рк╡рк┐рк╖ркпрлЛ рк╡рк┐рк╢рлЗ ркорк╛рк╣рк┐ркдрлА ркЖрккрлА рк╢ркХрлБркВ ркЫрлБркВред ркдркорк╛рк░рлЛ рккрлНрк░рк╢рлНрки рккрлВркЫрлЛ!';
    }

    // --- How are you ---
    if (_matchesAny(lower, ['ркХрлЗрко ркЫрлЛ', 'kem cho', 'рк╢рлБркВ рк╣рк╛рк▓', 'how are'])) {
      return 'рк╣рлБркВ рк╕рк╛рк░рлБркВ ркЫрлБркВ, ркЖркнрк╛рк░! рк╣рлБркВ ркдркорк╛рк░рлА рк╕рлЗрк╡рк╛ркорк╛ркВ ркдрлИркпрк╛рк░ ркЫрлБркВред ркЧрлБркЬрк░рк╛ркдрлА ркнрк╛рк╖рк╛, рк╕ркВрк╕рлНркХрлГркдрк┐, рк╡рк┐ркЬрлНркЮрк╛рки, ркЯрлЗркХркирлЛрк▓рлЛркЬрлА ркХрлЗ ркХрлЛркИрккркг рк╡рк┐рк╖ркп рк╡рк┐рк╢рлЗ рккрлВркЫрлЛ, рк╣рлБркВ ркоркжркж ркХрк░рлАрк╢ред';
    }

    // --- What is this / What can you do ---
    if (_matchesAny(lower, ['рк╢рлБркВ ркЫрлЗ', 'what is this', 'рк╢рлБркВ ркХрк░рлА рк╢ркХрлЛ', 'what can you', 'ркдркорлЗ ркХрлЛркг'])) {
      return 'рк╣рлБркВ ркЧрлБркЬрк░рк╛ркдрлА рк╡рк╛ркгрлА AI ркЫрлБркВ - ркПркХ ркЧрлБркЬрк░рк╛ркдрлА ркнрк╛рк╖рк╛ркирлЛ ркЪрлЗркЯркмрлЛркЯред рк╣рлБркВ ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ рк╡рк╛ркдркЪрлАркд ркХрк░рлА рк╢ркХрлБркВ ркЫрлБркВ, рккрлНрк░рк╢рлНркирлЛркирк╛ ркЬрк╡рк╛ркм ркЖрккрлА рк╢ркХрлБркВ ркЫрлБркВ, ркЕркирлЗ ркорк╛рк░рк╛ ркЬрк╡рк╛ркмрлЛ ркдркорлЗ TTS ркжрлНрк╡рк╛рк░рк╛ рк╕рк╛ркВркнрк│рлА рккркг рк╢ркХрлЛ ркЫрлЛред ркЧрлБркЬрк░рк╛ркд, ркнрк╛рк░ркд, рк╡рк┐ркЬрлНркЮрк╛рки, ркЯрлЗркХркирлЛрк▓рлЛркЬрлА, рк╕рк╛рк╣рк┐ркдрлНркп - ркХрлЛркИрккркг рк╡рк┐рк╖ркп рккрк░ рккрлВркЫрлЛ!';
    }

    // --- Gujarat ---
    if (_matchesAny(lower, ['ркЧрлБркЬрк░рк╛ркд', 'gujarat'])) {
      if (_matchesAny(lower, ['рк░рк╛ркЬркзрк╛ркирлА', 'capital'])) {
        return 'ркЧрлБркЬрк░рк╛ркдркирлА рк░рк╛ркЬркзрк╛ркирлА ркЧрк╛ркВркзрлАркиркЧрк░ ркЫрлЗред ркЧрк╛ркВркзрлАркиркЧрк░ ркнрк╛рк░ркдркирк╛ рк╕рлБркЖркпрлЛркЬрк┐ркд рк╢рк╣рлЗрк░рлЛркорк╛ркВркирлБркВ ркПркХ ркЫрлЗред ркЕрк╣рлАркВ ркЕркХрлНрк╖рк░ркзрк╛рко ркоркВркжрк┐рк░, рк╕рк░рк┐ркдрк╛ ркЙркжрлНркпрк╛рки ркЕркирлЗ ркЗркирлНрклрлЛрк╕рк┐ркЯрлА ркЬрлЗрк╡рк╛ркВ рккрлНрк░рк╕рк┐ркжрлНркз рк╕рлНркерк│рлЛ ркЫрлЗред ркЧрк╛ркВркзрлАркиркЧрк░ рк╕рк╛ркмрк░ркоркдрлА ркиркжрлАркирк╛ ркХрк┐ркирк╛рк░рлЗ рк╡рк╕рлЗрк▓рлБркВ ркЫрлЗред';
      }
      if (_matchesAny(lower, ['ркЬрк┐рк▓рлНрк▓рк╛', 'district', 'рк╢рк╣рлЗрк░', 'city'])) {
        return 'ркЧрлБркЬрк░рк╛ркдркорк╛ркВ рлйрлй ркЬрк┐рк▓рлНрк▓рк╛ ркЫрлЗред ркорлБркЦрлНркп рк╢рк╣рлЗрк░рлЛркорк╛ркВ ркЕркоркжрк╛рк╡рк╛ркж, рк╕рлБрк░ркд, рк╡ркбрлЛркжрк░рк╛, рк░рк╛ркЬркХрлЛркЯ, ркнрк╛рк╡ркиркЧрк░, ркЬрк╛ркоркиркЧрк░, ркЬрлВркирк╛ркЧркв, ркЧрк╛ркВркзрлАркиркЧрк░, ркЖркгркВркж ркЕркирлЗ ркорк╣рлЗрк╕рк╛ркгрк╛ркирлЛ рк╕ркорк╛рк╡рлЗрк╢ ркерк╛ркп ркЫрлЗред ркЕркоркжрк╛рк╡рк╛ркж ркЧрлБркЬрк░рк╛ркдркирлБркВ рк╕рлМркерлА ркорлЛркЯрлБркВ рк╢рк╣рлЗрк░ ркЫрлЗред';
      }
      if (_matchesAny(lower, ['рк╡рк╕рлНркдрлА', 'population', 'рк▓рлЛркХрлЛ'])) {
        return 'ркЧрлБркЬрк░рк╛ркдркирлА рк╡рк╕рлНркдрлА рк▓ркЧркнркЧ рлн ркХрк░рлЛркб ркЫрлЗред ркЧрлБркЬрк░рк╛ркд ркнрк╛рк░ркдркирлБркВ рккрк╛ркВркЪркорлБркВ рк╕рлМркерлА рк╡ркзрлБ рк╡рк╕рлНркдрлА ркзрк░рк╛рк╡ркдрлБркВ рк░рк╛ркЬрлНркп ркЫрлЗред ркЕрк╣рлАркВркирк╛ рк▓рлЛркХрлЛ ркЧрлБркЬрк░рк╛ркдрлА ркнрк╛рк╖рк╛ ркмрлЛрк▓рлЗ ркЫрлЗ ркЕркирлЗ рк╡рлНркпрк╛рккрк╛рк░-ркЙркжрлНркпрлЛркЧркорк╛ркВ ркЖркЧрк│ ркЫрлЗред';
      }
      return 'ркЧрлБркЬрк░рк╛ркд ркнрк╛рк░ркдркирк╛ рккрк╢рлНркЪрк┐рко ркнрк╛ркЧркорк╛ркВ ркЖрк╡рлЗрк▓рлБркВ ркПркХ рк╕ркорлГркжрлНркз рк░рк╛ркЬрлНркп ркЫрлЗред ркдрлЗркирлА рк░рк╛ркЬркзрк╛ркирлА ркЧрк╛ркВркзрлАркиркЧрк░ ркЫрлЗ ркЕркирлЗ ркЕркоркжрк╛рк╡рк╛ркж рк╕рлМркерлА ркорлЛркЯрлБркВ рк╢рк╣рлЗрк░ ркЫрлЗред ркЧрлБркЬрк░рк╛ркд ркЙркжрлНркпрлЛркЧ, рк╡рлНркпрк╛рккрк╛рк░, ркЦрк╛ркгрлАрккрлАркгрлА ркЕркирлЗ рк╕ркВрк╕рлНркХрлГркдрк┐ ркорк╛ркЯрлЗ рк╡рк┐рк╢рлНрк╡ркнрк░ркорк╛ркВ рккрлНрк░ркЦрлНркпрк╛ркд ркЫрлЗред ркЧрлАрк░, ркХркЪрлНркЫ, рк╕рлЛркоркирк╛рке, ркжрлНрк╡рк╛рк░ркХрк╛ ркЬрлЗрк╡рк╛ рккрлНрк░рк╡рк╛рк╕рки рк╕рлНркерк│рлЛ ркЕрк╣рлАркВ ркЫрлЗред';
    }

    // --- Ahmedabad ---
    if (_matchesAny(lower, ['ркЕркоркжрк╛рк╡рк╛ркж', 'ahmedabad'])) {
      return 'ркЕркоркжрк╛рк╡рк╛ркж ркЧрлБркЬрк░рк╛ркдркирлБркВ рк╕рлМркерлА ркорлЛркЯрлБркВ рк╢рк╣рлЗрк░ ркЫрлЗ ркЕркирлЗ ркнрк╛рк░ркдркирлБркВ рккрк╛ркВркЪркорлБркВ рк╕рлМркерлА ркорлЛркЯрлБркВ рк╢рк╣рлЗрк░ ркЫрлЗред рк╕рк╛ркмрк░ркоркдрлА ркиркжрлАркирк╛ ркХрк┐ркирк╛рк░рлЗ рк╡рк╕рлЗрк▓рлБркВ ркЖ рк╢рк╣рлЗрк░ UNESCO рк╡рк░рлНрк▓рлНркб рк╣рлЗрк░рк┐ркЯрлЗркЬ рк╕рк┐ркЯрлА ркЫрлЗред ркЕрк╣рлАркВ рк╕рк╛ркмрк░ркоркдрлА ркЖрк╢рлНрк░рко, ркХрк╛ркВркХрк░рк┐ркпрк╛ ркдрк│рк╛рк╡, ркЬрлВркирлБркВ рк╢рк╣рлЗрк░, ркЕркирлЗ IIM ркЕркоркжрк╛рк╡рк╛ркж ркЬрлЗрк╡рлА рккрлНрк░рк╕рк┐ркжрлНркз ркЬркЧрлНркпрк╛ркУ ркЫрлЗред';
    }

    // --- Surat ---
    if (_matchesAny(lower, ['рк╕рлБрк░ркд', 'surat'])) {
      return 'рк╕рлБрк░ркд ркЧрлБркЬрк░рк╛ркдркирлБркВ ркмрлАркЬрлБркВ рк╕рлМркерлА ркорлЛркЯрлБркВ рк╢рк╣рлЗрк░ ркЫрлЗ. ркдрлЗ рк╣рлАрк░рк╛ ркЙркжрлНркпрлЛркЧ ркЕркирлЗ ркЯрлЗркХрлНрк╕рлНркЯрк╛ркИрк▓ ркЙркжрлНркпрлЛркЧ ркорк╛ркЯрлЗ рк╡рк┐рк╢рлНрк╡ркнрк░ркорк╛ркВ рккрлНрк░ркЦрлНркпрк╛ркд ркЫрлЗ. рк╕рлБрк░ркдркирлЗ "ркбрк╛ркпркоркВркб рк╕рк┐ркЯрлА" ркЕркирлЗ "рк╕рк┐рк▓рлНркХ рк╕рк┐ркЯрлА" ркдрк░рлАркХрлЗ ркУрк│ркЦрк╡рк╛ркорк╛ркВ ркЖрк╡рлЗ ркЫрлЗ. ркЕрк╣рлАркВркирлА ркЦрк╛ркгрлАрккрлАркгрлА ркЦрк╛рк╕ ркХрк░рлАркирлЗ рк▓рлЛркЪрлЛ ркЕркирлЗ ркЙркВркзрк┐ркпрлБркВ ркЦрлВркм рккрлНрк░ркЦрлНркпрк╛ркд ркЫрлЗред';
    }

    // --- Food ---
    if (_matchesAny(lower, ['ркЦрк╛рк╡рлБркВ', 'ркЦрлЛрк░рк╛ркХ', 'food', 'рк░рк╕рлЛркИ', 'рк╡рк╛ркиркЧрлА', 'ркЦрк╛ркгрлАрккрлАркгрлА', 'recipe', 'ркЬркорк╡рк╛ркирлБркВ'])) {
      if (_matchesAny(lower, ['ркврлЛркХрк│рк╛', 'dhokla'])) {
        return 'ркврлЛркХрк│рк╛ ркЧрлБркЬрк░рк╛ркдркирлА рк╕рлМркерлА рккрлНрк░ркЦрлНркпрк╛ркд рк╡рк╛ркиркЧрлА ркЫрлЗред ркЪркгрк╛ркирк╛ рк▓рлЛркЯ ркЕркерк╡рк╛ ркЦрк╛ркЯрлА ркИркбрк▓рлА ркЬрлЗрк╡рк╛ ркЦрлАрк░рк╛ркорк╛ркВркерлА ркмркирлЗ ркЫрлЗред ркдрлЗркирлЗ рк╡рк░рк╛рк│ркерлА рк░рк╛ркВркзрк╡рк╛ркорк╛ркВ ркЖрк╡рлЗ ркЫрлЗ ркЕркирлЗ рк░рк╛ркИ-ркорк░ркЪрк╛ркВ-рк▓рлАркоркбрк╛ркирк╛ рккрк╛ркиркирк╛ рк╡ркШрк╛рк░ркерлА рк╕ркЬрк╛рк╡рк╡рк╛ркорк╛ркВ ркЖрк╡рлЗ ркЫрлЗред ркврлЛркХрк│рк╛ рк╣рк│рк╡рк╛, рккрлМрк╖рлНркЯрк┐ркХ ркЕркирлЗ рк╕рлНрк╡рк╛ркжрк┐рк╖рлНркЯ ркирк╛рк╕рлНркдрлЛ ркЫрлЗред';
      }
      if (_matchesAny(lower, ['ркЙркВркзрк┐ркпрлБркВ', 'undhiyu'])) {
        return 'ркЙркВркзрк┐ркпрлБркВ ркЧрлБркЬрк░рк╛ркдркирлА рк╢рк┐ркпрк╛рк│рк╛ркирлА рк╕рлМркерлА рккрлНрк░ркЦрлНркпрк╛ркд рк╡рк╛ркиркЧрлА ркЫрлЗред ркдрлЗркорк╛ркВ рк░рлАркВркЧркг, ркмркЯрк╛ркХрк╛, рк░ркдрк╛рк│рлБркВ, ркХркВркж, рккрк╛рккркбрлА, рк╡рк╛рк▓ ркЕркирлЗ ркорлЗркерлАркирк╛ ркЧрлЛркЯрк╛ рк╡рккрк░рк╛ркп ркЫрлЗред "ркЙркВркзрк┐ркпрлБркВ" ркирк╛рко "ркЙркВркзрлБркВ" рк╢ркмрлНркж рккрк░ркерлА ркЖрк╡рлНркпрлБркВ ркЫрлЗ ркХрк╛рк░ркг ркХрлЗ ркдрлЗркирлЗ ркорк╛ркЯрлАркирк╛ рк╡рк╛рк╕ркгркорк╛ркВ ркКркВркзрлБркВ рк░рк╛ркВркзрк╡рк╛ркорк╛ркВ ркЖрк╡ркдрлБркВ рк╣ркдрлБркВред';
      }
      return 'ркЧрлБркЬрк░рк╛ркдрлА ркЦрк╛ркгрлАрккрлАркгрлА ркнрк╛рк░ркдркорк╛ркВ рк╕рлМркерлА рк╡рк┐рк╢рк┐рк╖рлНркЯ ркЫрлЗред ркврлЛркХрк│рк╛, ркЦрк╛ркВркбрк╡рлА, ркерлЗрккрк▓рк╛, рклрк╛рклркбрк╛-ркЬрк▓рлЗркмрлА, ркЙркВркзрк┐ркпрлБркВ, ркЪрлЗрк╡ркбрлЛ, ркЦркоркг, рк╣рк╛ркВркбрк╡рлЛ рккрлНрк░ркЦрлНркпрк╛ркд ркирк╛рк╕рлНркдрк╛ ркЫрлЗред ркЧрлБркЬрк░рк╛ркдрлА ркерк╛рк│рлАркорк╛ркВ ркжрк╛рк│, ркнрк╛ркд, рк╢рк╛ркХ, рк░рлЛркЯрк▓рлА, ркЫрк╛рк╢, ркЕркерк╛ркгрлБркВ ркЕркирлЗ рдорк┐ркарк╛ркИ рк╣рлЛркп ркЫрлЗред ркЧрлБркЬрк░рк╛ркдрлА ркЦрк╛ркгрлАрккрлАркгрлА ркорлАркарк╛рк╢ ркЕркирлЗ ркдрлАркЦрк╛рк╢ркирк╛ рк╕рлБркВркжрк░ рк╕ркВркдрлБрк▓рки ркорк╛ркЯрлЗ ркЬрк╛ркгрлАркдрлА ркЫрлЗред';
    }

    // --- Gandhi ---
    if (_matchesAny(lower, ['ркЧрк╛ркВркзрлА', 'gandhi', 'ркмрк╛рккрлБ', 'ркорк╣рк╛ркдрлНркорк╛'])) {
      return 'ркорк╣рк╛ркдрлНркорк╛ ркЧрк╛ркВркзрлА ркнрк╛рк░ркдркирк╛ рк░рк╛рк╖рлНркЯрлНрк░рккрк┐ркдрк╛ ркЫрлЗред ркдрлЗркоркирлЛ ркЬркирлНрко рли ркУркХрлНркЯрлЛркмрк░ рлзрлорлмрлп ркорк╛ркВ ркЧрлБркЬрк░рк╛ркдркирк╛ рккрлЛрк░ркмркВркжрк░ркорк╛ркВ ркеркпрлЛ рк╣ркдрлЛред ркдрлЗркоркгрлЗ ркЕрк╣рк┐ркВрк╕рк╛ ркЕркирлЗ рк╕ркдрлНркпрк╛ркЧрлНрк░рк╣ркирк╛ ркорк╛рк░рлНркЧрлЗ ркнрк╛рк░ркдркирлЗ ркЖркЭрк╛ркжрлА ркЕрккрк╛рк╡рлАред ркжрк╛ркВркбрлА ркХрлВркЪ, ркнрк╛рк░ркд ркЫрлЛркбрлЛ ркЖркВркжрлЛрк▓рки ркЕркирлЗ ркЪркВрккрк╛рк░ркг рк╕ркдрлНркпрк╛ркЧрлНрк░рк╣ ркдрлЗркоркирк╛ ркорк╣ркдрлНрк╡ркирк╛ ркЖркВркжрлЛрк▓ркирлЛ рк╣ркдрк╛ред';
    }

    // --- Weather ---
    if (_matchesAny(lower, ['рк╣рк╡рк╛ркорк╛рки', 'weather', 'рк╡рк░рк╕рк╛ркж', 'ркЧрк░ркорлА', 'ркаркВркбрлА', 'ркдрк╛рккркорк╛рки'])) {
      return 'ркЧрлБркЬрк░рк╛ркдркорк╛ркВ ркдрлНрк░ркг ркорлБркЦрлНркп ркЛркдрлБркУ ркЫрлЗред ркЙркирк╛рк│рк╛ркорк╛ркВ (ркорк╛рк░рлНркЪ-ркЬрлВрки) ркдрк╛рккркорк╛рки рлйрлл ркерлА рлкрлл ркбрк┐ркЧрлНрк░рлА рк╕рлЗрк▓рлНрк╕рк┐ркпрк╕ рк╕рлБркзрлА рккрк╣рлЛркВркЪрлЗ ркЫрлЗред ркЪрлЛркорк╛рк╕рлБркВ (ркЬрлБрк▓рк╛ркИ-рк╕рккрлНркЯрлЗркорлНркмрк░) ркорк╛ркВ рк╕рк╛рк░рлЛ рк╡рк░рк╕рк╛ркж рккркбрлЗ ркЫрлЗред рк╢рк┐ркпрк╛рк│рк╛ркорк╛ркВ (ркирк╡рлЗркорлНркмрк░-рклрлЗркмрлНрк░рлБркЖрк░рлА) рк╣рк╡рк╛ркорк╛рки рк╕рлБркЦркж рк╣рлЛркп ркЫрлЗ ркЕркирлЗ ркдрк╛рккркорк╛рки рлзрлж ркерлА рлирлл ркбрк┐ркЧрлНрк░рлА рк╣рлЛркп ркЫрлЗред';
    }

    // --- History ---
    if (_matchesAny(lower, ['ркИркдрк┐рк╣рк╛рк╕', 'history', 'ркЗркдрк┐рк╣рк╛рк╕', 'рккрлНрк░рк╛ркЪрлАрки', 'ancient'])) {
      return 'ркЧрлБркЬрк░рк╛ркдркирлЛ ркЗркдрк┐рк╣рк╛рк╕ рллрлжрлжрлж рк╡рк░рлНрк╖ ркЬрлВркирлЛ ркЫрлЗред рк╕рк┐ркВркзрлБ ркЦрлАркг рк╕ркВрк╕рлНркХрлГркдрк┐ркирлБркВ рккрлНрк░рк╛ркЪрлАрки ркмркВркжрк░ рк▓рлЛркерк▓ ркЧрлБркЬрк░рк╛ркдркорк╛ркВ ркЫрлЗред ркЪрк╛рк▓рлБркХрлНркп, рк╕рлЛрк▓ркВркХрлА, рк╡рк╛ркШрлЗрк▓рк╛ ркЕркирлЗ ркорлБркШрк▓ рк░рк╛ркЬрк╡ркВрк╢рлЛркП ркЧрлБркЬрк░рк╛ркд рккрк░ рк╢рк╛рк╕рки ркХрк░рлНркпрлБркВред рлзрлпрлмрлж ркорк╛ркВ ркЧрлБркЬрк░рк╛ркд ркорк╣рк╛рк░рк╛рк╖рлНркЯрлНрк░ркерлА ркЕрк▓ркЧ ркеркИ рк╕рлНрк╡ркдркВркдрлНрк░ рк░рк╛ркЬрлНркп ркмркирлНркпрлБркВред';
    }

    // --- Thanks ---
    if (_matchesAny(lower, ['ркЖркнрк╛рк░', 'ркзркирлНркпрк╡рк╛ркж', 'thank', 'thanks'])) {
      return 'ркдркорк╛рк░рлБркВ рк╕рлНрк╡рк╛ркЧркд ркЫрлЗ! рк╣рлБркВ рк╣ркВркорлЗрк╢рк╛ ркоркжркж ркХрк░рк╡рк╛ ркдрлИркпрк╛рк░ ркЫрлБркВред ркХрлЛркИ ркмрлАркЬрлЛ рккрлНрк░рк╢рлНрки рк╣рлЛркп ркдрлЛ ркЬрк░рлВрк░ рккрлВркЫрлЛред ркЧрлБркЬрк░рк╛ркдрлА ркнрк╛рк╖рк╛ркорк╛ркВ рк╡рк╛ркдркЪрлАркд ркХрк░рк╡рк╛ркирлА ркоркЬрк╛ ркЫрлЗ!';
    }

    // --- Language / Gujarati Language ---
    if (_matchesAny(lower, ['ркнрк╛рк╖рк╛', 'language', 'ркЧрлБркЬрк░рк╛ркдрлА ркнрк╛рк╖рк╛', 'рк▓рк┐рккрк┐', 'script', 'ркорлВрк│рк╛ркХрлНрк╖рк░'])) {
      return 'ркЧрлБркЬрк░рк╛ркдрлА ркнрк╛рк╖рк╛ ркИркирлНркбрлЛ-ркЖрк░рлНркп ркнрк╛рк╖рк╛ рккрк░рк┐рк╡рк╛рк░ркирлА ркЫрлЗред рк╡рк┐рк╢рлНрк╡ркнрк░ркорк╛ркВ рк▓ркЧркнркЧ рлм ркХрк░рлЛркб рк▓рлЛркХрлЛ ркЧрлБркЬрк░рк╛ркдрлА ркмрлЛрк▓рлЗ ркЫрлЗред ркЧрлБркЬрк░рк╛ркдрлА рк▓рк┐рккрк┐ ркжрлЗрк╡ркирк╛ркЧрк░рлА рк▓рк┐рккрк┐ркерлА ркЙркдрлНрккркирлНрки ркеркпрлЗрк▓рлА ркЫрлЗ рккрк░ркВркдрлБ ркдрлЗркорк╛ркВ рк╢рк┐рк░рлЛрк░рлЗркЦрк╛ (ркЙрккрк░ркирлА рк▓рк╛ркИрки) ркиркерлА рк╣рлЛркдрлАред ркЧрлБркЬрк░рк╛ркдрлА рк╕рк╛рк╣рк┐ркдрлНркп ркЦрлВркм рк╕ркорлГркжрлНркз ркЫрлЗ ркЬрлЗркорк╛ркВ ркирк░рк╕рк┐ркВрк╣ ркорк╣рлЗркдрк╛, ркЧрк╛ркВркзрлАркЬрлА, ркЭрк╡рлЗрк░ркЪркВркж ркорлЗркШрк╛ркгрлА ркЬрлЗрк╡рк╛ ркорк╣рк╛рки рк╕рк╛рк╣рк┐ркдрлНркпркХрк╛рк░рлЛ ркЫрлЗред';
    }

    // --- Literature ---
    if (_matchesAny(lower, ['рк╕рк╛рк╣рк┐ркдрлНркп', 'literature', 'ркХрк╡рк┐', 'poet', 'рк▓рлЗркЦркХ', 'writer', 'рккрлБрк╕рлНркдркХ'])) {
      return 'ркЧрлБркЬрк░рк╛ркдрлА рк╕рк╛рк╣рк┐ркдрлНркп ркЦрлВркм рк╕ркорлГркжрлНркз ркЫрлЗред ркирк░рк╕рк┐ркВрк╣ ркорк╣рлЗркдрк╛ ркЧрлБркЬрк░рк╛ркдрлА ркнрк╛рк╖рк╛ркирк╛ ркЖркжрк┐ ркХрк╡рк┐ ркЫрлЗ, ркдрлЗркоркгрлЗ "рк╡рлИрк╖рлНркгрк╡ ркЬрки ркдрлЛ" рк▓ркЦрлНркпрлБркВ. ркЭрк╡рлЗрк░ркЪркВркж ркорлЗркШрк╛ркгрлА "рк░рк╛рк╖рлНркЯрлНрк░рлАркп рк╢рк╛ркпрк░" ркдрк░рлАркХрлЗ ркУрк│ркЦрк╛ркп ркЫрлЗ. ркХ.рк▓рк╛. рк╕рлНрк╡рк╛ркорлА, ркЧрлЛрк╡рк░рлНркзркирк░рк╛рко ркдрлНрк░рк┐рккрк╛ркарлА, рккркирлНркирк╛рк▓рк╛рк▓ рккркЯрлЗрк▓ ркЕркирлЗ ркЙркорк╛рк╢ркВркХрк░ ркЬрлЛрк╢рлА ркЧрлБркЬрк░рк╛ркдрлА рк╕рк╛рк╣рк┐ркдрлНркпркирк╛ рк╕рлНркдркВркн ркЫрлЗред';
    }

    // --- Temple / Religion ---
    if (_matchesAny(lower, ['ркоркВркжрк┐рк░', 'temple', 'ркзрк░рлНрко', 'religion', 'рк╕рлЛркоркирк╛рке', 'ркжрлНрк╡рк╛рк░ркХрк╛', 'ркЕркХрлНрк╖рк░ркзрк╛рко', 'ркнркЧрк╡рк╛рки'])) {
      return 'ркЧрлБркЬрк░рк╛ркдркорк╛ркВ ркШркгрк╛ рккрлНрк░рк╕рк┐ркжрлНркз ркоркВркжрк┐рк░рлЛ ркЫрлЗред рк╕рлЛркоркирк╛рке ркоркВркжрк┐рк░ ркмрк╛рк░ ркЬрлНркпрлЛркдрк┐рк░рлНрк▓рк┐ркВркЧркорк╛ркВркирлБркВ рккрлНрк░ркерко ркЫрлЗред ркжрлНрк╡рк╛рк░ркХрк╛ркзрлАрк╢ ркоркВркжрк┐рк░ ркнркЧрк╡рк╛рки ркХрлГрк╖рлНркгркирлБркВ ркзрк╛рко ркЫрлЗред ркЕркХрлНрк╖рк░ркзрк╛рко ркоркВркжрк┐рк░ ркЧрк╛ркВркзрлАркиркЧрк░ркорк╛ркВ ркЖрк╡рлЗрк▓рлБркВ рк╡рк┐рк╢рлНрк╡рккрлНрк░рк╕рк┐ркжрлНркз ркоркВркжрк┐рк░ ркЫрлЗред рккрк╛рк╡рк╛ркЧркв-ркЪрк╛ркВрккрк╛ркирлЗрк░, ркЧрк┐рк░ркирк╛рк░ ркЕркирлЗ рккрк╛рк▓рк┐ркдрк╛ркгрк╛ рккркг рккрлНрк░рк╕рк┐ркжрлНркз ркдрлАрк░рлНркерк╕рлНркерк╛ркирлЛ ркЫрлЗред';
    }

    // --- Technology ---
    if (_matchesAny(lower, ['ркЯрлЗркХркирлЛрк▓рлЛркЬрлА', 'technology', 'ркХркорлНрккрлНркпрлБркЯрк░', 'computer', 'AI', 'ркЗркирлНркЯрк░ркирлЗркЯ', 'internet', 'ркорлЛркмрк╛ркИрк▓', 'mobile', 'рк╕рлЛрклрлНркЯрк╡рлЗрк░'])) {
      return 'ркЯрлЗркХркирлЛрк▓рлЛркЬрлА ркХрлНрк╖рлЗркдрлНрк░ркорк╛ркВ ркЧрлБркЬрк░рк╛ркд ркЭркбрккркерлА ркЖркЧрк│ рк╡ркзрлА рк░рк╣рлНркпрлБркВ ркЫрлЗред ркЕркоркжрк╛рк╡рк╛ркж ркЕркирлЗ ркЧрк╛ркВркзрлАркиркЧрк░ркорк╛ркВ IT ркЙркжрлНркпрлЛркЧ рк╡рк┐ркХрк╕рлА рк░рк╣рлНркпрлЛ ркЫрлЗред GIFT City ркЧрк╛ркВркзрлАркиркЧрк░ркорк╛ркВ ркнрк╛рк░ркдркирлБркВ рккрлНрк░ркерко ркЗркирлНркЯрк░ркирлЗрк╢ркирк▓ рклрк╛ркИркирк╛ркирлНрк╕рк┐ркпрк▓ рк╕рлЗркирлНркЯрк░ ркЫрлЗред ркЧрлБркЬрк░рк╛ркдркорк╛ркВ ркШркгрк╛ ркПркирлНркЬрк┐ркирк┐ркпрк░рк┐ркВркЧ ркХрлЛрк▓рлЗркЬрлЛ ркЕркирлЗ IT ркХркВрккркирлАркУ ркЫрлЗред';
    }

    // --- Education ---
    if (_matchesAny(lower, ['рк╢рк┐ркХрлНрк╖ркг', 'education', 'ркпрлБркирк┐рк╡рк░рлНрк╕рк┐ркЯрлА', 'university', 'рк╢рк╛рк│рк╛', 'school', 'ркХрлЛрк▓рлЗркЬ', 'college', 'рккрк░рлАркХрлНрк╖рк╛'])) {
      return 'ркЧрлБркЬрк░рк╛ркдркорк╛ркВ рк╢рк┐ркХрлНрк╖ркг ркХрлНрк╖рлЗркдрлНрк░рлЗ ркШркгрлА рккрлНрк░ркЧркдрк┐ ркеркИ ркЫрлЗред IIM ркЕркоркжрк╛рк╡рк╛ркж ркнрк╛рк░ркдркирлА ркЯрлЛркЪркирлА ркорлЗркирлЗркЬркорлЗркирлНркЯ рк╕ркВрк╕рлНркерк╛ ркЫрлЗред NID, CEPT, ркЧрлБркЬрк░рк╛ркд ркпрлБркирк┐рк╡рк░рлНрк╕рк┐ркЯрлА, MS ркпрлБркирк┐рк╡рк░рлНрк╕рк┐ркЯрлА рк╡ркбрлЛркжрк░рк╛ рккрлНрк░ркЦрлНркпрк╛ркд рк╢рлИркХрлНрк╖ркгрк┐ркХ рк╕ркВрк╕рлНркерк╛ркУ ркЫрлЗред ркЧрлБркЬрк░рк╛ркдркорк╛ркВ рк╕рк╛ркХрлНрк╖рк░ркдрк╛ ркжрк░ рк▓ркЧркнркЧ рлорли ркЯркХрк╛ ркЫрлЗред';
    }

    // --- Festival ---
    if (_matchesAny(lower, ['ркдрк╣рлЗрк╡рк╛рк░', 'festival', 'ркирк╡рк░рк╛ркдрлНрк░рлА', 'navratri', 'ркжрк┐рк╡рк╛рк│рлА', 'diwali', 'ркЙркдрлНркдрк░рк╛ркпркг', 'makar sankranti', 'рк╣рлЛрк│рлА', 'рккркдркВркЧ'])) {
      if (_matchesAny(lower, ['ркирк╡рк░рк╛ркдрлНрк░рлА', 'navratri', 'ркЧрк░ркмрк╛', 'garba'])) {
        return 'ркирк╡рк░рк╛ркдрлНрк░рлА ркЧрлБркЬрк░рк╛ркдркирлЛ рк╕рлМркерлА ркорлЛркЯрлЛ ркдрк╣рлЗрк╡рк╛рк░ ркЫрлЗред ркирк╡ рк░рк╛ркд рк╕рлБркзрлА ркЧрк░ркмрк╛ ркЕркирлЗ ркжрк╛ркВркбрк┐ркпрк╛ рк░рк╛рк╕ рк░ркорк╛ркп ркЫрлЗред ркЧрлБркЬрк░рк╛ркдркирлЛ ркЧрк░ркмрк╛ UNESCO ркирлА ркЕркорлВрк░рлНркд рк╕рк╛ркВрк╕рлНркХрлГркдрк┐ркХ рк╡рк┐рк░рк╛рк╕ркдркорк╛ркВ рк╕рк╛ркорлЗрк▓ ркЫрлЗред рк▓рк╛ркЦрлЛ рк▓рлЛркХрлЛ рк░ркВркЧркмрлЗрк░ркВркЧрлА ркХрккркбрк╛ркВ рккрк╣рлЗрк░рлАркирлЗ ркЧрк░ркмрк╛ рк░ркорлЗ ркЫрлЗред';
      }
      if (_matchesAny(lower, ['ркЙркдрлНркдрк░рк╛ркпркг', 'makar', 'рккркдркВркЧ', 'kite'])) {
        return 'ркЙркдрлНркдрк░рк╛ркпркг (ркоркХрк░рк╕ркВркХрлНрк░рк╛ркВркдрк┐) рлзрлк ркЬрк╛ркирлНркпрлБркЖрк░рлАркП ркЙркЬрк╡рк╛ркп ркЫрлЗред ркЧрлБркЬрк░рк╛ркдркорк╛ркВ ркЖ ркжрк┐рк╡рк╕рлЗ ркЖркХрк╛рк╢ рк░ркВркЧркмрлЗрк░ркВркЧрлА рккркдркВркЧрлЛркерлА ркнрк░рк╛ркИ ркЬрк╛ркп ркЫрлЗред "ркХрк╛ркИ рккрлЛ ркЫрлЗ!" ркП рккрлНрк░ркЦрлНркпрк╛ркд рк╕рлВркдрлНрк░ ркЫрлЗ. ркЙркВркзрк┐ркпрлБркВ ркЕркирлЗ ркЬрк▓рлЗркмрлА ркЖ ркжрк┐рк╡рк╕ркирлБркВ ркЦрк╛рк╕ ркнрлЛркЬрки ркЫрлЗред';
      }
      return 'ркЧрлБркЬрк░рк╛ркдркорк╛ркВ ркШркгрк╛ ркдрк╣рлЗрк╡рк╛рк░рлЛ ркЙркЬрк╡рк╛ркп ркЫрлЗред ркирк╡рк░рк╛ркдрлНрк░рлА (ркЧрк░ркмрк╛), ркЙркдрлНркдрк░рк╛ркпркг (рккркдркВркЧ), ркжрк┐рк╡рк╛рк│рлА, рк╣рлЛрк│рлА, рк░ркХрлНрк╖рк╛ркмркВркзрки ркЕркирлЗ ркЬркирлНркорк╛рк╖рлНркЯркорлА ркорлБркЦрлНркп ркдрк╣рлЗрк╡рк╛рк░рлЛ ркЫрлЗред ркирк╡рк░рк╛ркдрлНрк░рлА ркжрлБркирк┐ркпрк╛ркирлЛ рк╕рлМркерлА рк▓рк╛ркВркмрлЛ ркбрк╛ркирлНрк╕ рклрлЗрк╕рлНркЯрк┐рк╡рк▓ ркЫрлЗред ркЙркдрлНркдрк░рк╛ркпркг ркжрлБркирк┐ркпрк╛ркирлЛ рк╕рлМркерлА ркорлЛркЯрлЛ рккркдркВркЧ ркЙркдрлНрк╕рк╡ ркЫрлЗред';
    }

    // --- Tourism / Places ---
    if (_matchesAny(lower, ['рккрлНрк░рк╡рк╛рк╕', 'tourism', 'travel', 'рклрк░рк╡рк╛', 'ркЬрлЛрк╡рк╛рк▓рк╛ркпркХ', 'visit', 'ркЧрлАрк░', 'gir', 'ркХркЪрлНркЫ', 'kutch'])) {
      if (_matchesAny(lower, ['ркЧрлАрк░', 'gir', 'рк╕рк┐ркВрк╣', 'lion'])) {
        return 'ркЧрлАрк░ рк░рк╛рк╖рлНркЯрлНрк░рлАркп ркЙркжрлНркпрк╛рки ркПрк╢рк┐ркпрк╛ркИ рк╕рк┐ркВрк╣рлЛркирлБркВ ркПркХркорк╛ркдрлНрк░ ркШрк░ ркЫрлЗред ркЖ ркЬркВркЧрк▓ ркЧрлБркЬрк░рк╛ркдркирк╛ ркЬрлВркирк╛ркЧркв ркЬрк┐рк▓рлНрк▓рк╛ркорк╛ркВ ркЖрк╡рлЗрк▓рлБркВ ркЫрлЗред ркЕрк╣рлАркВ рк▓ркЧркнркЧ рлнрлжрлж ркерлА рк╡ркзрлБ рк╕рк┐ркВрк╣рлЛ рк╡рк╕рлЗ ркЫрлЗред ркЧрлАрк░ ркЬркВркЧрк▓ рлзрлкрлзрли ркЪрлЛрк░рк╕ ркХрк┐рк▓рлЛркорлАркЯрк░ рк╡рк┐рк╕рлНркдрк╛рк░ркорк╛ркВ рклрлЗрк▓рк╛ркпрлЗрк▓рлБркВ ркЫрлЗред';
      }
      if (_matchesAny(lower, ['ркХркЪрлНркЫ', 'kutch', 'рк░ркг', 'rann'])) {
        return 'ркХркЪрлНркЫркирлБркВ рк░ркг рк╡рк┐рк╢рлНрк╡ркирлБркВ рк╕рлМркерлА ркорлЛркЯрлБркВ ркорлАркарк╛ркирлБркВ рк░ркг ркЫрлЗред ркжрк░ рк╡рк░рлНрк╖рлЗ рк╢рк┐ркпрк╛рк│рк╛ркорк╛ркВ "рк░ркг ркЙркдрлНрк╕рк╡" ркпрлЛркЬрк╛ркп ркЫрлЗ ркЬрлНркпрк╛ркВ рк▓рк╛ркЦрлЛ рккрлНрк░рк╡рк╛рк╕рлАркУ ркЖрк╡рлЗ ркЫрлЗред рккрлВрк░рлНркгрк┐ркорк╛ркирлА рк░рк╛ркдрлЗ рк╕рклрлЗркж рк░ркг ркЪрк╛ркВркжркирлАркорк╛ркВ ркЭрк│рк╣рк│рлЗ ркЫрлЗ. ркХркЪрлНркЫркирлА ркнрк░ркдркХрк╛рко ркЕркирлЗ рк╣рк╕рлНркдркХрк│рк╛ рк╡рк┐рк╢рлНрк╡рккрлНрк░рк╕рк┐ркжрлНркз ркЫрлЗред';
      }
      return 'ркЧрлБркЬрк░рк╛ркдркорк╛ркВ ркЕркирлЗркХ рккрлНрк░рк╡рк╛рк╕рки рк╕рлНркерк│рлЛ ркЫрлЗред ркЧрлАрк░ (рк╕рк┐ркВрк╣рлЛ), ркХркЪрлНркЫркирлБркВ рк░ркг, рк╕рлЛркоркирк╛рке, ркжрлНрк╡рк╛рк░ркХрк╛, рк╕рлНркЯрлЗркЪрлНркпрлВ ркУркл ркпрлБркирк┐ркЯрлА (рк╡рк┐рк╢рлНрк╡ркирлА рк╕рлМркерлА ркКркВркЪрлА рккрлНрк░ркдрк┐ркорк╛), ркЪрк╛ркВрккрк╛ркирлЗрк░-рккрк╛рк╡рк╛ркЧркв, рк▓рлЛркерк▓ ркЕркирлЗ рк╕рк╛рккрлБркдрк╛рк░рк╛ ркЬрлЛрк╡рк╛рк▓рк╛ркпркХ ркЫрлЗред';
    }

    // --- Statue of Unity ---
    if (_matchesAny(lower, ['рк╕рлНркЯрлЗркЪрлНркпрлВ', 'statue', 'рк╕рк░ркжрк╛рк░', 'рккркЯрлЗрк▓', 'patel', 'ркПркХркдрк╛'])) {
      return 'рк╕рлНркЯрлЗркЪрлНркпрлВ ркУркл ркпрлБркирк┐ркЯрлА рк╡рк┐рк╢рлНрк╡ркирлА рк╕рлМркерлА ркКркВркЪрлА рккрлНрк░ркдрк┐ркорк╛ ркЫрлЗ, ркЬрлЗ рлзрлорли ркорлАркЯрк░ ркКркВркЪрлА ркЫрлЗред ркдрлЗ рк╕рк░ркжрк╛рк░ рк╡рк▓рлНрк▓ркнркнрк╛ркИ рккркЯрлЗрк▓ркирлА ркпрк╛ркжркорк╛ркВ ркЧрлБркЬрк░рк╛ркдркирк╛ ркХрлЗрк╡ркбрк┐ркпрк╛ ркЦрк╛ркдрлЗ ркмркирк╛рк╡рк╡рк╛ркорк╛ркВ ркЖрк╡рлА ркЫрлЗред рк╕рк░ркжрк╛рк░ рккркЯрлЗрк▓рлЗ ркнрк╛рк░ркдркирк╛ рллрлмрли рк░ркЬрк╡рк╛ркбрк╛ркУркирлЗ ркПркХркдрлНрк░ ркХрк░рлА ркнрк╛рк░ркдркирлЗ ркПркХ рк░рк╛рк╖рлНркЯрлНрк░ ркмркирк╛рк╡рлНркпрлБркВ рк╣ркдрлБркВред';
    }

    // --- Cricket / Sport ---
    if (_matchesAny(lower, ['ркХрлНрк░рк┐ркХрлЗркЯ', 'cricket', 'рк░ркоркд', 'sport', 'ркЦрлЗрк▓', 'ркЦрлЗрк▓рк╛ркбрлА', 'IPL'])) {
      return 'ркЧрлБркЬрк░рк╛ркдркорк╛ркВ ркХрлНрк░рк┐ркХрлЗркЯ ркЦрлВркм рк▓рлЛркХрккрлНрк░рк┐ркп ркЫрлЗред ркирк░рлЗркирлНркжрлНрк░ ркорлЛркжрлА рк╕рлНркЯрлЗркбрк┐ркпрко ркЕркоркжрк╛рк╡рк╛ркжркорк╛ркВ рк╡рк┐рк╢рлНрк╡ркирлБркВ рк╕рлМркерлА ркорлЛркЯрлБркВ ркХрлНрк░рк┐ркХрлЗркЯ рк╕рлНркЯрлЗркбрк┐ркпрко ркЫрлЗ, ркЬрлЗркорк╛ркВ рлз,рлйрли,рлжрлжрлж ркжрк░рлНрк╢ркХрлЛркирлА ркХрлНрк╖ркоркдрк╛ ркЫрлЗред ркЧрлБркЬрк░рк╛ркд ркЯрк╛ркИркЯркирлНрк╕ IPL ркЯрлАрко ркЫрлЗред ркИрк░рклрк╛рки рккркарк╛ркг, ркЪрлЗркдрлЗрк╢рлНрк╡рк░ рккрлБркЬрк╛рк░рк╛, ркЬрк╕рккрлНрк░рлАркд ркмрлБркорк░рк╛рк╣ ркЧрлБркЬрк░рк╛ркдркирк╛ рккрлНрк░ркЦрлНркпрк╛ркд ркХрлНрк░рк┐ркХрлЗркЯрк░рлЛ ркЫрлЗред';
    }

    // --- Science ---
    if (_matchesAny(lower, ['рк╡рк┐ркЬрлНркЮрк╛рки', 'science', 'ркЕрк╡ркХрк╛рк╢', 'space', 'ISRO', 'ркнрлМркдрк┐ркХ', 'physics', 'рк░рк╕рк╛ркпркг', 'chemistry'])) {
      return 'ркЧрлБркЬрк░рк╛ркд рк╡рк┐ркЬрлНркЮрк╛рки ркХрлНрк╖рлЗркдрлНрк░рлЗ ркорк╣ркдрлНрк╡ркирлБркВ ркпрлЛркЧркжрк╛рки ркзрк░рк╛рк╡рлЗ ркЫрлЗред рк╡рк┐ркХрлНрк░рко рк╕рк╛рк░рк╛ркнрк╛ркИ ISRO ркирк╛ рк╕рлНркерк╛рккркХ рк╣ркдрк╛ ркЕркирлЗ ркдрлЗркУ ркЕркоркжрк╛рк╡рк╛ркжркирк╛ рк╣ркдрк╛ред PRL (рклрк┐ркЭрк┐ркХрк▓ рк░рк┐рк╕рк░рлНркЪ рк▓рлЗркмрлЛрк░рлЗркЯрк░рлА) ркЕркоркжрк╛рк╡рк╛ркжркорк╛ркВ ркЫрлЗред ркЕркоркжрк╛рк╡рк╛ркжркорк╛ркВ рк╕рк╛ркпркирлНрк╕ рк╕рк┐ркЯрлА ркнрк╛рк░ркдркирлБркВ рк╕рлМркерлА ркорлЛркЯрлБркВ рк╡рк┐ркЬрлНркЮрк╛рки ркХрлЗркирлНркжрлНрк░ ркЫрлЗред';
    }

    // --- Business / Economy ---
    if (_matchesAny(lower, ['ркЙркжрлНркпрлЛркЧ', 'industry', 'ркмрк┐ркЭркирлЗрк╕', 'business', 'ркЕрк░рлНркеркдркВркдрлНрк░', 'economy', 'рк╡рлНркпрк╛рккрк╛рк░', 'trade'])) {
      return 'ркЧрлБркЬрк░рк╛ркд ркнрк╛рк░ркдркирлБркВ ркФркжрлНркпрлЛркЧрк┐ркХ рк░рк╛ркЬрлНркп ркЫрлЗред ркЕрк╣рлАркВ ркЯрлЗркХрлНрк╕рлНркЯрк╛ркИрк▓, рк╣рлАрк░рк╛, рклрк╛рк░рлНркорк╛, рккрлЗркЯрлНрк░рлЛркХрлЗркорк┐ркХрк▓ ркЕркирлЗ ркУркЯрлЛркорлЛркмрк╛ркИрк▓ ркЙркжрлНркпрлЛркЧрлЛ рк╡рк┐ркХрк╕рк┐ркд ркЫрлЗред рк░рк┐рк▓рк╛ркпркирлНрк╕, ркЕркжрк╛ркгрлА, ркЯрлЛрк░рлЗркирлНркЯ ркЬрлЗрк╡рлА ркорлЛркЯрлА ркХркВрккркирлАркУ ркЧрлБркЬрк░рк╛ркдркирлА ркЫрлЗред рк╕рлБрк░ркд рк╡рк┐рк╢рлНрк╡ркирлБркВ рлпрлж ркЯркХрк╛ рк╣рлАрк░рк╛ рккрлЛрк▓рк┐рк╢ ркХрк░рлЗ ркЫрлЗред';
    }

    // --- Help / name ---
    if (_matchesAny(lower, ['ркоркжркж', 'help', 'ркирк╛рко', 'name', 'ркХрлЛркг ркЫрлЛ'])) {
      return 'рк╣рлБркВ ркЧрлБркЬрк░рк╛ркдрлА рк╡рк╛ркгрлА AI рк╕рк╣рк╛ркпркХ ркЫрлБркВред рк╣рлБркВ ркЧрлБркЬрк░рк╛ркдрлА ркнрк╛рк╖рк╛ркорк╛ркВ ркдркорк╛рк░рк╛ рккрлНрк░рк╢рлНркирлЛркирк╛ ркЬрк╡рк╛ркм ркЖрккрлБркВ ркЫрлБркВред ркдркорлЗ ркорк╛рк░рк╛ ркЬрк╡рк╛ркмрлЛ ЁЯФК ркмркЯрки ркжркмрк╛рк╡рлАркирлЗ рк╕рк╛ркВркнрк│рлА рккркг рк╢ркХрлЛ ркЫрлЛред ркЧрлБркЬрк░рк╛ркд, ркнрк╛рк░ркд, рк╡рк┐ркЬрлНркЮрк╛рки, ркЯрлЗркХркирлЛрк▓рлЛркЬрлА, рк╕рк╛рк╣рк┐ркдрлНркп, ркЦрк╛ркгрлАрккрлАркгрлА - ркХрлЛркИрккркг рк╡рк┐рк╖ркп рккрк░ рккрлВркЫрлЛ!';
    }

    // --- Numbers ---
    if (_matchesAny(lower, ['ркЧркгрк┐ркд', 'math', 'ркЧркгркдрк░рлА', 'number', 'рк╕ркВркЦрлНркпрк╛', 'ркЕркВркХ'])) {
      return 'ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ рлж ркерлА рлп ркЕркВркХрлЛ ркЖ ркЫрлЗ: рлж (рк╢рлВркирлНркп), рлз (ркПркХ), рли (ркмрлЗ), рлй (ркдрлНрк░ркг), рлк (ркЪрк╛рк░), рлл (рккрк╛ркВркЪ), рлм (ркЫ), рлн (рк╕рк╛ркд), рло (ркЖрка), рлп (ркирк╡). ркЧрлБркЬрк░рк╛ркдрлА ркЧркгрк┐ркд рккрк░ркВрккрк░рк╛ ркШркгрлА рк╕ркорлГркжрлНркз ркЫрлЗ. рк╢рлВркирлНркпркирлА рк╢рлЛркз ркнрк╛рк░ркдркорк╛ркВ ркеркИ рк╣ркдрлАред';
    }

    // --- General questions with "рк╢рлБркВ" ---
    if (lower.contains('рк╢рлБркВ')) {
      return 'ркдркорк╛рк░рлЛ рккрлНрк░рк╢рлНрки рк░рк╕рккрлНрк░ркж ркЫрлЗ! рк╣рлБркВ ркЧрлБркЬрк░рк╛ркдрлА ркнрк╛рк╖рк╛ркорк╛ркВ ркШркгрк╛ рк╡рк┐рк╖ркпрлЛ рк╡рк┐рк╢рлЗ рк╡рк╛ркд ркХрк░рлА рк╢ркХрлБркВ ркЫрлБркВ - ркЧрлБркЬрк░рк╛ркдркирлЛ ркИркдрк┐рк╣рк╛рк╕, рк╕ркВрк╕рлНркХрлГркдрк┐, ркЦрк╛ркгрлАрккрлАркгрлА, ркдрк╣рлЗрк╡рк╛рк░рлЛ, рккрлНрк░рк╡рк╛рк╕рки, рк╡рк┐ркЬрлНркЮрк╛рки, ркЯрлЗркХркирлЛрк▓рлЛркЬрлА рк╡ркЧрлЗрк░рлЗ. ркХрлГрккрк╛ ркХрк░рлАркирлЗ рк╡ркзрлБ рк╡рк┐ркЧркдрк╡рк╛рк░ рккрлНрк░рк╢рлНрки рккрлВркЫрлЛ ркЬрлЗркерлА рк╣рлБркВ рк╡ркзрлБ рк╕рк╛рк░рлЛ ркЬрк╡рк╛ркм ркЖрккрлА рк╢ркХрлБркВред';
    }

    // --- Bye ---
    if (_matchesAny(lower, ['ркмрк╛ркп', 'bye', 'ркЖрк╡ркЬрлЛ', 'goodbye', 'ркЯрк╛ркЯрк╛'])) {
      return 'ркЖрк╡ркЬрлЛ! ркдркорк╛рк░рлА рк╕рк╛ркерлЗ рк╡рк╛ркд ркХрк░рлАркирлЗ ркЖркиркВркж ркеркпрлЛ. рклрк░рлА ркХрлНркпрк╛рк░рлЗркп ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ рк╡рк╛ркд ркХрк░рк╡рк╛ ркЖрк╡ркЬрлЛ. ркЬркп рк╣рк┐ркирлНркж, ркЬркп ркЧрлБркЬрк░рк╛ркд! ЁЯЩП';
    }

    // --- Default response ---
    return 'ркдркорк╛рк░рлЛ рккрлНрк░рк╢рлНрки рк╕рк╛рк░рлЛ ркЫрлЗ! рк╣рлБркВ ркЧрлБркЬрк░рк╛ркдрлА ркнрк╛рк╖рк╛ркорк╛ркВ ркШркгрк╛ рк╡рк┐рк╖ркпрлЛ рк╡рк┐рк╢рлЗ ркорк╛рк╣рк┐ркдрлА ркЖрккрлА рк╢ркХрлБркВ ркЫрлБркВ:\n\nтАв ркЧрлБркЬрк░рк╛ркдркирлЛ ркИркдрк┐рк╣рк╛рк╕ ркЕркирлЗ рк╕ркВрк╕рлНркХрлГркдрк┐\nтАв ркЦрк╛ркгрлАрккрлАркгрлА ркЕркирлЗ рк╡рк╛ркиркЧрлАркУ\nтАв ркдрк╣рлЗрк╡рк╛рк░рлЛ (ркирк╡рк░рк╛ркдрлНрк░рлА, ркЙркдрлНркдрк░рк╛ркпркг)\nтАв рккрлНрк░рк╡рк╛рк╕рки (ркЧрлАрк░, ркХркЪрлНркЫ, рк╕рлНркЯрлЗркЪрлНркпрлВ)\nтАв рк╡рк┐ркЬрлНркЮрк╛рки ркЕркирлЗ ркЯрлЗркХркирлЛрк▓рлЛркЬрлА\nтАв рк╕рк╛рк╣рк┐ркдрлНркп ркЕркирлЗ ркнрк╛рк╖рк╛\n\nркХрлГрккрк╛ ркХрк░рлАркирлЗ ркЙрккрк░ркирк╛ ркХрлЛркИ рк╡рк┐рк╖ркп рк╡рк┐рк╢рлЗ ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ рккрлВркЫрлЛ!';
  }

  /// Helper to check if text matches any keyword
  bool _matchesAny(String text, List<String> keywords) {
    return keywords.any((k) => text.contains(k));
  }

  Future<void> _playMessageAudio(int index) async {
    final message = _messages[index];

    // If already playing this message, stop it
    if (_playingIndex == index) {
      await _audioPlayer.stop();
      setState(() => _playingIndex = null);
      return;
    }

    // If audio already generated, play it
    if (message.audioPath != null) {
      await _audioPlayer.stop();
      await _audioPlayer.play(DeviceFileSource(message.audioPath!));
      setState(() => _playingIndex = index);
      return;
    }

    // Check if text is Gujarati
    final lang = TTSService.detectLanguage(message.text);
    if (lang != 'gujarati' && lang != 'mixed') {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
            content: Text(
                'Only Gujarati text can be converted to speech\nрклркХрлНркд ркЧрлБркЬрк░рк╛ркдрлА ркЯрлЗркХрлНрк╕рлНркЯркирлЗ рк╕рлНрккрлАркЪркорк╛ркВ рк░рлВрккрк╛ркВркдрк░рк┐ркд ркХрк░рлА рк╢ркХрк╛ркп ркЫрлЗ'),
            backgroundColor: Colors.orange,
          ),
        );
      }
      return;
    }

    // Generate audio
    setState(() {
      _messages[index].isGeneratingAudio = true;
    });

    bool hasInternet = await TTSService.checkInternet();
    if (!hasInternet) {
      setState(() => _messages[index].isGeneratingAudio = false);
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(
              content: Text('No internet connection'),
              backgroundColor: Colors.red),
        );
      }
      return;
    }

    final path = await TTSService.synthesize(message.text);

    if (path != null && mounted) {
      setState(() {
        _messages[index].audioPath = path;
        _messages[index].isGeneratingAudio = false;
      });
      await _audioPlayer.play(DeviceFileSource(path));
      setState(() => _playingIndex = index);
    } else if (mounted) {
      setState(() => _messages[index].isGeneratingAudio = false);
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
            content: Text('Failed to generate audio'),
            backgroundColor: Colors.red),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Column(
        children: [
          // Messages list
          Expanded(
            child: ListView.builder(
              controller: _scrollController,
              padding: const EdgeInsets.fromLTRB(12, 12, 12, 8),
              itemCount: _messages.length + (_isTyping ? 1 : 0),
              itemBuilder: (context, index) {
                if (index == _messages.length && _isTyping) {
                  return _buildTypingIndicator();
                }
                return _buildMessageBubble(index);
              },
            ),
          ),

          // Input area
          Container(
            decoration: BoxDecoration(
              color: Colors.white,
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withOpacity(0.08),
                  blurRadius: 8,
                  offset: const Offset(0, -2),
                ),
              ],
            ),
            padding: const EdgeInsets.fromLTRB(12, 8, 8, 12),
            child: Row(
              children: [
                Expanded(
                  child: TextField(
                    controller: _messageController,
                    decoration: InputDecoration(
                      hintText: 'ркЧрлБркЬрк░рк╛ркдрлАркорк╛ркВ рк▓ркЦрлЛ... (Type in Gujarati...)',
                      hintStyle:
                          TextStyle(color: Colors.grey[400], fontSize: 14),
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(24),
                        borderSide: BorderSide(color: Colors.grey[300]!),
                      ),
                      focusedBorder: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(24),
                        borderSide:
                            const BorderSide(color: Colors.orange, width: 2),
                      ),
                      filled: true,
                      fillColor: Colors.grey[50],
                      contentPadding: const EdgeInsets.symmetric(
                          horizontal: 18, vertical: 12),
                    ),
                    style: const TextStyle(fontSize: 16),
                    maxLines: 3,
                    minLines: 1,
                    textInputAction: TextInputAction.send,
                    onSubmitted: (_) => _sendMessage(),
                  ),
                ),
                const SizedBox(width: 8),
                Container(
                  decoration: const BoxDecoration(
                    color: Colors.orange,
                    shape: BoxShape.circle,
                  ),
                  child: IconButton(
                    onPressed: _isTyping ? null : _sendMessage,
                    icon: const Icon(Icons.send_rounded),
                    color: Colors.white,
                    iconSize: 22,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildTypingIndicator() {
    return Align(
      alignment: Alignment.centerLeft,
      child: Container(
        margin: const EdgeInsets.only(bottom: 8, right: 60),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        decoration: BoxDecoration(
          color: Colors.grey[100],
          borderRadius: BorderRadius.circular(18),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            _buildDot(0),
            const SizedBox(width: 4),
            _buildDot(1),
            const SizedBox(width: 4),
            _buildDot(2),
          ],
        ),
      ),
    );
  }

  Widget _buildDot(int index) {
    return TweenAnimationBuilder<double>(
      tween: Tween(begin: 0.0, end: 1.0),
      duration: Duration(milliseconds: 600 + (index * 200)),
      builder: (context, value, child) {
        return Container(
          width: 8,
          height: 8,
          decoration: BoxDecoration(
            color: Colors.grey[400]!.withOpacity(0.5 + (value * 0.5)),
            shape: BoxShape.circle,
          ),
        );
      },
    );
  }

  Widget _buildMessageBubble(int index) {
    final message = _messages[index];
    final isUser = message.isUser;
    final isPlaying = _playingIndex == index;

    return Align(
      alignment: isUser ? Alignment.centerRight : Alignment.centerLeft,
      child: Container(
        margin: EdgeInsets.only(
          bottom: 10,
          left: isUser ? 50 : 0,
          right: isUser ? 0 : 50,
        ),
        child: Column(
          crossAxisAlignment:
              isUser ? CrossAxisAlignment.end : CrossAxisAlignment.start,
          children: [
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
              decoration: BoxDecoration(
                color: isUser ? Colors.orange : Colors.grey[100],
                borderRadius: BorderRadius.only(
                  topLeft: const Radius.circular(18),
                  topRight: const Radius.circular(18),
                  bottomLeft: Radius.circular(isUser ? 18 : 4),
                  bottomRight: Radius.circular(isUser ? 4 : 18),
                ),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.06),
                    blurRadius: 6,
                    offset: const Offset(0, 2),
                  ),
                ],
              ),
              child: Text(
                message.text,
                style: TextStyle(
                  fontSize: 15,
                  color: isUser ? Colors.white : Colors.black87,
                  height: 1.4,
                ),
              ),
            ),
            const SizedBox(height: 4),
            // Listen button for AI responses
            if (!isUser)
              Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  if (message.isGeneratingAudio)
                    Container(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 10, vertical: 4),
                      decoration: BoxDecoration(
                        color: Colors.orange[50],
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          SizedBox(
                            width: 14,
                            height: 14,
                            child: CircularProgressIndicator(
                              strokeWidth: 2,
                              color: Colors.orange[700],
                            ),
                          ),
                          const SizedBox(width: 6),
                          Text('Generating...',
                              style: TextStyle(
                                  fontSize: 11, color: Colors.orange[700])),
                        ],
                      ),
                    )
                  else
                    InkWell(
                      onTap: () => _playMessageAudio(index),
                      borderRadius: BorderRadius.circular(12),
                      child: Container(
                        padding: const EdgeInsets.symmetric(
                            horizontal: 10, vertical: 4),
                        decoration: BoxDecoration(
                          color: isPlaying
                              ? Colors.orange[100]
                              : Colors.orange[50],
                          borderRadius: BorderRadius.circular(12),
                          border: Border.all(
                            color: isPlaying
                                ? Colors.orange
                                : Colors.orange[200]!,
                          ),
                        ),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Icon(
                              isPlaying
                                  ? Icons.stop_rounded
                                  : Icons.volume_up_rounded,
                              size: 16,
                              color: Colors.orange[700],
                            ),
                            const SizedBox(width: 4),
                            Text(
                              isPlaying ? 'Stop' : 'Listen ЁЯФК',
                              style: TextStyle(
                                fontSize: 11,
                                color: Colors.orange[700],
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                  const SizedBox(width: 8),
                  Text(
                    '${message.timestamp.hour}:${message.timestamp.minute.toString().padLeft(2, '0')}',
                    style: TextStyle(fontSize: 10, color: Colors.grey[400]),
                  ),
                ],
              ),
            if (isUser)
              Padding(
                padding: const EdgeInsets.only(right: 4),
                child: Text(
                  '${message.timestamp.hour}:${message.timestamp.minute.toString().padLeft(2, '0')}',
                  style: TextStyle(fontSize: 10, color: Colors.grey[400]),
                ),
              ),
          ],
        ),
      ),
    );
  }
}
